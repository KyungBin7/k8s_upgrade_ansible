---
# Kubernetes admin.conf ë°°í¬ ë° kubectl ì„¤ì • í”Œë ˆì´ë¶
# í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ì „ì— í•œë²ˆë§Œ ì‹¤í–‰
# 1. ê¸°ë³¸ ì‹¤í–‰ (ëª¨ë“  ë…¸ë“œì— kubectl ì„¤ì •)
#ansible-playbook -i inventory/hosts k8s_cluster_upgrade/tasks/00_setup-kubectl.yml

# 2. íŠ¹ì • ë…¸ë“œë§Œ ì‹¤í–‰
#ansible-playbook -i inventory/hosts k8s_cluster_upgrade/tasks/00_setup-kubectl.yml --limit "control_plane,workers"

# 3. ìƒì„¸ ë¡œê·¸ì™€ í•¨ê»˜ ì‹¤í–‰
#ansible-playbook -i inventory/hosts k8s_cluster_upgrade/tasks/00_setup-kubectl.yml -v

# 4. ì²´í¬ ëª¨ë“œë¡œ ë¨¼ì € í™•ì¸
#ansible-playbook -i inventory/hosts k8s_cluster_upgrade/tasks/00_setup-kubectl.yml --check

- name: "ğŸ”§ Kubernetes admin.conf ë°°í¬ ë° kubectl ì„¤ì •"
  hosts: all
  become: yes
  gather_facts: yes
  serial: 1
  vars:
    first_master: "{{ groups['control_plane'][0] | default(groups['all'][0]) }}"
    admin_conf_path: "/etc/kubernetes/admin.conf"
    
  tasks:
    - name: "ğŸ“‹ ì‘ì—… ì‹œì‘ ë¡œê·¸"
      debug:
        msg: "{{ inventory_hostname }}ì—ì„œ kubectl ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤"

    # ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ admin.conf ì¡´ì¬ í™•ì¸
    - name: "ğŸ” ì²« ë²ˆì§¸ ë§ˆìŠ¤í„°ì—ì„œ admin.conf íŒŒì¼ ì¡´ì¬ í™•ì¸"
      stat:
        path: "{{ admin_conf_path }}"
      register: admin_conf_stat
      when: inventory_hostname == first_master
      
    - name: "âŒ admin.conf íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨"
      fail:
        msg: "{{ admin_conf_path }} íŒŒì¼ì´ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
      when: 
        - inventory_hostname == first_master
        - not admin_conf_stat.stat.exists

    # ì²« ë²ˆì§¸ ë§ˆìŠ¤í„°ê°€ ì•„ë‹Œ ë…¸ë“œë“¤ì„ ìœ„í•œ ì‘ì—…
    - name: "ğŸ“ .kube ë””ë ‰í† ë¦¬ ìƒì„±"
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
      when: inventory_hostname != first_master

    - name: "ğŸ“ root .kube ë””ë ‰í† ë¦¬ ìƒì„±"
      file:
        path: "/root/.kube"
        state: directory
        mode: '0755'
        owner: root
        group: root
      when: inventory_hostname != first_master

    # ì²« ë²ˆì§¸ ë§ˆìŠ¤í„°ì—ì„œ admin.conf ë‚´ìš© ì½ê¸°
    - name: "ğŸ“¥ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„°ì—ì„œ admin.conf ë‚´ìš© ì½ê¸°"
      slurp:
        src: "{{ admin_conf_path }}"
      register: admin_conf_content
      delegate_to: "{{ first_master }}"
      run_once: true

    # ë‹¤ë¥¸ ë…¸ë“œë“¤ì—ê²Œ admin.conf ë³µì‚¬
    - name: "ğŸ“¤ admin.confë¥¼ ë‹¤ë¥¸ ë…¸ë“œë“¤ì— ë³µì‚¬"
      copy:
        content: "{{ admin_conf_content.content | b64decode }}"
        dest: "/root/admin.conf"
        mode: '0644'
        owner: root
        group: root
      when: inventory_hostname != first_master

    # ì‚¬ìš©ì í™ˆ ë””ë ‰í† ë¦¬ì— kubectl config ì„¤ì •
    - name: "ğŸ”§ ì‚¬ìš©ì í™ˆì— kubectl config ë³µì‚¬"
      copy:
        src: "/root/admin.conf"
        dest: "{{ ansible_env.HOME }}/.kube/config"
        mode: '0644'
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        remote_src: yes
      when: inventory_hostname != first_master

    # root ì‚¬ìš©ìì—ê²Œë„ kubectl config ì„¤ì •
    - name: "ğŸ”§ root ì‚¬ìš©ìì—ê²Œ kubectl config ë³µì‚¬"
      copy:
        src: "/root/admin.conf"
        dest: "/root/.kube/config"
        mode: '0644'
        owner: root
        group: root
        remote_src: yes
      when: inventory_hostname != first_master

    # ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë„ .kube/config ì„¤ì •
    - name: "ğŸ”§ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„°ì—ì„œ kubectl config ì„¤ì •"
      block:
        - name: "ğŸ“ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° .kube ë””ë ‰í† ë¦¬ ìƒì„±"
          file:
            path: "{{ ansible_env.HOME }}/.kube"
            state: directory
            mode: '0755'
            owner: "{{ ansible_user_id }}"
            group: "{{ ansible_user_gid }}"

        - name: "ğŸ“ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° root .kube ë””ë ‰í† ë¦¬ ìƒì„±"
          file:
            path: "/root/.kube"
            state: directory
            mode: '0755'
            owner: root
            group: root

        - name: "ğŸ”§ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° ì‚¬ìš©ì í™ˆì— kubectl config ë³µì‚¬"
          copy:
            src: "{{ admin_conf_path }}"
            dest: "{{ ansible_env.HOME }}/.kube/config"
            mode: '0644'
            owner: "{{ ansible_user_id }}"
            group: "{{ ansible_user_gid }}"
            remote_src: yes

        - name: "ğŸ”§ ì²« ë²ˆì§¸ ë§ˆìŠ¤í„° rootì— kubectl config ë³µì‚¬"
          copy:
            src: "{{ admin_conf_path }}"
            dest: "/root/.kube/config"
            mode: '0644'
            owner: root
            group: root
            remote_src: yes
      when: inventory_hostname == first_master

    # KUBECONFIG í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.bashrc)
    - name: "ğŸŒ ì‚¬ìš©ì .bashrcì— KUBECONFIG í™˜ê²½ë³€ìˆ˜ ì¶”ê°€"
      lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: 'export KUBECONFIG="$HOME/.kube/config"'
        state: present
        create: yes
        backup: yes
      when: ansible_env.HOME != "/root"

    # root ì‚¬ìš©ì .bashrcì—ë„ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
    - name: "ğŸŒ root .bashrcì— KUBECONFIG í™˜ê²½ë³€ìˆ˜ ì¶”ê°€"
      lineinfile:
        path: "/root/.bashrc"
        line: 'export KUBECONFIG="$HOME/.kube/config"'
        state: present
        create: yes
        backup: yes

    # kubectl ì—°ê²° í…ŒìŠ¤íŠ¸
    - name: "ğŸ” kubectl ì—°ê²° í…ŒìŠ¤íŠ¸"
      shell: |
        export KUBECONFIG="$HOME/.kube/config"
        kubectl cluster-info
      register: kubectl_test
      failed_when: false
      changed_when: false

    - name: "âœ… kubectl ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼"
      debug:
        msg: 
          - "kubectl ì—°ê²° í…ŒìŠ¤íŠ¸ {{ 'ì„±ê³µ' if kubectl_test.rc == 0 else 'ì‹¤íŒ¨' }}"
          - "{{ kubectl_test.stdout_lines if kubectl_test.rc == 0 else kubectl_test.stderr_lines }}"

    # ë…¸ë“œë³„ admin.conf ì„ì‹œ íŒŒì¼ ì •ë¦¬
    - name: "ğŸ§¹ ë…¸ë“œ ì„ì‹œ íŒŒì¼ ì •ë¦¬"
      file:
        path: "/root/admin.conf"
        state: absent
      when: inventory_hostname != first_master

    - name: "âœ… ì‘ì—… ì™„ë£Œ ë¡œê·¸"
      debug:
        msg: "{{ inventory_hostname }}ì—ì„œ kubectl ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"

  handlers:
    - name: "reload bashrc"
      shell: source ~/.bashrc
      args:
        executable: /bin/bash 
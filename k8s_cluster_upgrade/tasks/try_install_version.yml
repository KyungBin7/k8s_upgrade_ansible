---
# íŠ¹ì • íŒ¨ì¹˜ ë²„ì „ìœ¼ë¡œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„

- name: "íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„: {{ patch_version }}"
  debug:
    msg: "ğŸ“¦ {{ patch_version }} ë²„ì „ìœ¼ë¡œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ë¥¼ ì‹œë„í•©ë‹ˆë‹¤."

# í˜„ì¬ ë²„ì „ìœ¼ë¡œ íŒ¨í‚¤ì§€ ë¦¬ìŠ¤íŠ¸ ìƒì„±
- name: "í˜„ì¬ ë²„ì „ìš© íŒ¨í‚¤ì§€ ë¦¬ìŠ¤íŠ¸ ìƒì„±"
  set_fact:
    k8s_current_packages: "{{ k8s_package_base_names | map('regex_replace', '^(.*)$', '\\1=' + patch_version + '-*') | list }}"

- name: "ì„¤ì¹˜í•  íŒ¨í‚¤ì§€ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ"
  debug:
    msg: "ì„¤ì¹˜í•  íŒ¨í‚¤ì§€: {{ k8s_current_packages | join(', ') }}"

# YUM íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
- name: "íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„ (yum): {{ patch_version }}"
  yum:
    name: "{{ k8s_current_packages }}"
    state: present
    disable_excludes: kubernetes
    update_cache: yes
  register: yum_install_result
  when: k8s_detected_package_manager == "yum"
  ignore_errors: true

# APT íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
- name: "íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ (apt)"
  apt:
    update_cache: yes
  when: k8s_detected_package_manager == "apt"
  ignore_errors: true

- name: "íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„ (apt): {{ patch_version }}"
  apt:
    name: "{{ k8s_current_packages }}"
    state: present
    force: yes
  register: apt_install_result
  when: k8s_detected_package_manager == "apt"
  ignore_errors: true

# ì„¤ì¹˜ ê²°ê³¼ í™•ì¸
- name: "ì„¤ì¹˜ ê²°ê³¼ í™•ì¸"
  set_fact:
    k8s_install_success: "{{ (yum_install_result is defined and yum_install_result is succeeded) or (apt_install_result is defined and apt_install_result is succeeded) }}"

- name: "ì„¤ì¹˜ ì„±ê³µ ì‹œ ì„±ê³µ ì •ë³´ ì €ì¥"
  set_fact:
    k8s_package_install_success: true
    k8s_successful_version: "{{ patch_version }}"
    k8s_successful_packages: "{{ k8s_current_packages }}"
  when: k8s_install_success

- name: "ì„¤ì¹˜ ì„±ê³µ ì•Œë¦¼"
  debug:
    msg: 
      - "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì„±ê³µ!"
      - "  ì„±ê³µí•œ ë²„ì „: {{ patch_version }}"
      - "  ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€: {{ k8s_current_packages | join(', ') }}"
  when: k8s_install_success

- name: "ì„¤ì¹˜ ì‹¤íŒ¨ ì•Œë¦¼"
  debug:
    msg: 
      - "âŒ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨: {{ patch_version }}"
      - "  ì‹œë„í•œ íŒ¨í‚¤ì§€: {{ k8s_current_packages | join(', ') }}"
      - "  ì˜¤ë¥˜ (yum): {{ yum_install_result.msg | default('N/A') }}"
      - "  ì˜¤ë¥˜ (apt): {{ apt_install_result.msg | default('N/A') }}"
  when: not k8s_install_success 
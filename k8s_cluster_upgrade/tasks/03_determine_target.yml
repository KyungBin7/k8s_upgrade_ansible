---
# ëª©í‘œ ë²„ì „ ê²°ì •

- name: "ëª©í‘œ ë²„ì „ì´ ì´ë¯¸ ì„¤ì •ëœ ê²½ìš° ê²€ì¦"
  debug:
    msg: "ì„¤ì •ëœ ëª©í‘œ ë²„ì „: {{ k8s_target_version }}"
  when: k8s_target_version != ""

- name: "ê°•ì œ ë²„ì „ ì„¤ì • í™•ì¸"
  debug:
    msg: "ê°•ì œ ë²„ì „ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
  when: k8s_force_version

# ìë™ ë‹¤ìŒ ë²„ì „ ê²°ì •
- name: "ë²„ì „ ë§¤íŠ¸ë¦­ìŠ¤ì—ì„œ ë‹¤ìŒ ë²„ì „ ì°¾ê¸°"
  set_fact:
    k8s_next_version: "{{ k8s_version_matrix[k8s_current_minor_version].next_version }}"
  when: 
    - k8s_target_version == ""
    - k8s_current_minor_version in k8s_version_matrix
    - not k8s_force_version

- name: "ë‹¤ìŒ ë²„ì „ ìë™ ì„¤ì •"
  set_fact:
    k8s_target_version: "v{{ k8s_next_version }}.0"
  when: 
    - k8s_target_version == ""
    - k8s_next_version is defined
    - not k8s_force_version

# ìµœì‹  íŒ¨ì¹˜ ë²„ì „ í™•ì¸
- name: "ìµœì‹  íŒ¨ì¹˜ ë²„ì „ í™•ì¸ (ì˜¨ë¼ì¸)"
  uri:
    url: "{{ k8s_binary_base_url }}/stable-{{ k8s_next_version | default(k8s_target_version | regex_replace('^v', '') | regex_replace('\\.[0-9]+$', '')) }}.txt"
    method: GET
    timeout: 10
    return_content: yes
  register: latest_patch_version
  ignore_errors: true
  when: 
    - network_check is not failed
    - not (k8s_version_fallback_enabled | default(false) and (k8s_next_version | default(k8s_target_version | regex_replace('^v', '') | regex_replace('\\.[0-9]+$', '')) is version(k8s_version_fallback_min_version | default('1.30'), '>=')))

- name: "ìµœì‹  íŒ¨ì¹˜ ë²„ì „ ì‘ë‹µ ë””ë²„ê·¸"
  debug:
    var: latest_patch_version
  when: latest_patch_version is defined

- name: "ìµœì‹  íŒ¨ì¹˜ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸"
  set_fact:
    k8s_target_version: "{{ latest_patch_version.content.strip() }}"
  when:
    - latest_patch_version is defined
    - latest_patch_version is succeeded
    - latest_patch_version.content is defined
    - not k8s_force_version
    - k8s_target_version != ""

- name: "1.30 ì´í›„ ë²„ì „ ì˜¨ë¼ì¸ í™•ì¸ ê±´ë„ˆë›°ê¸° ì•Œë¦¼"
  debug:
    msg:
      - "â„¹ï¸  1.30 ì´í›„ ë²„ì „ì— ëŒ€í•´ì„œëŠ” ì˜¨ë¼ì¸ ìµœì‹  íŒ¨ì¹˜ í™•ì¸ì„ ê±´ë„ˆë›°ê³  fallback ë¡œì§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
      - "  ëŒ€ìƒ ë²„ì „: {{ k8s_next_version | default(k8s_target_version | regex_replace('^v', '') | regex_replace('\\.[0-9]+$', '')) }}"
      - "  í˜„ì¬ íƒ€ê²Ÿ ë²„ì „: {{ k8s_target_version }}"
  when:
    - k8s_version_fallback_enabled | default(false)
    - (k8s_next_version | default(k8s_target_version | regex_replace('^v', '') | regex_replace('\\.[0-9]+$', '')) is version(k8s_version_fallback_min_version | default('1.30'), '>='))

# OS í˜¸í™˜ì„± í™•ì¸
- name: "í˜„ì¬ OS ë¬¸ìì—´ ìƒì„±"
  set_fact:
    current_os_string: "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}"

- name: "ëª©í‘œ ë²„ì „ì˜ OS í˜¸í™˜ì„± í™•ì¸"
  set_fact:
    k8s_target_minor_version: "{{ k8s_target_version | regex_replace('^v', '') | regex_replace('\\.[0-9]+$', '') }}"

- name: "ëª©í‘œ ë²„ì „ ì •ë³´ ë””ë²„ê¹…"
  debug:
    msg:
      - "ëª©í‘œ ë²„ì „ ë””ë²„ê¹… ì •ë³´:"
      - "  k8s_target_version: {{ k8s_target_version }}"
      - "  k8s_target_minor_version: {{ k8s_target_minor_version }}"
      - "  current_os_string: {{ current_os_string }}"
      - "  ë§¤íŠ¸ë¦­ìŠ¤ì— ë²„ì „ ì¡´ì¬: {{ k8s_target_minor_version in k8s_version_matrix }}"
      - "  ì‚¬ìš© ê°€ëŠ¥í•œ ë§¤íŠ¸ë¦­ìŠ¤ ë²„ì „: {{ k8s_version_matrix.keys() | list }}"

- name: "OS í˜¸í™˜ì„± ê²€ì¦"
  fail:
    msg: "ëª©í‘œ ë²„ì „ {{ k8s_target_version }}ì€ í˜„ì¬ OS ({{ current_os_string }})ì™€ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
  when:
    - k8s_target_minor_version in k8s_version_matrix
    - k8s_version_matrix[k8s_target_minor_version].supported_os is defined
    - current_os_string not in k8s_version_matrix[k8s_target_minor_version].supported_os

- name: "ë§¤íŠ¸ë¦­ìŠ¤ì— ì—†ëŠ” ë²„ì „ ê²½ê³ "
  debug:
    msg: "ê²½ê³ : ëª©í‘œ ë²„ì „ {{ k8s_target_minor_version }}ì´ ë²„ì „ ë§¤íŠ¸ë¦­ìŠ¤ì— ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. OS í˜¸í™˜ì„± ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤."
  when: k8s_target_minor_version not in k8s_version_matrix

# 1.30 ì´í›„ ë²„ì „ì— ëŒ€í•œ íŒ¨í‚¤ì§€ ë²„ì „ fallback ë¡œì§
- name: "1.30 ì´í›„ ë²„ì „ì— ëŒ€í•œ fallback í™œì„±í™” ì—¬ë¶€ í™•ì¸"
  set_fact:
    k8s_need_fallback: "{{ k8s_target_minor_version is version(k8s_version_fallback_min_version, '>=') }}"
  when: k8s_version_fallback_enabled | default(false)

- name: "Fallback ì ìš© ì—¬ë¶€ ë””ë²„ê¹…"
  debug:
    msg:
      - "ğŸ” Fallback ì„¤ì • í™•ì¸:"
      - "  fallback_enabled: {{ k8s_version_fallback_enabled | default(false) }}"
      - "  target_minor_version: {{ k8s_target_minor_version | default('N/A') }}"
      - "  fallback_min_version: {{ k8s_version_fallback_min_version | default('N/A') }}"
      - "  need_fallback: {{ k8s_need_fallback | default(false) }}"
      - "  current_target_version: {{ k8s_target_version | default('N/A') }}"
  when: k8s_version_fallback_enabled | default(false)

- name: "ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „ í™•ì¸"
  set_fact:
    k8s_available_patches: "{{ k8s_version_matrix[k8s_target_minor_version].available_patch_versions | default([]) }}"
  when: 
    - k8s_need_fallback | default(false)
    - k8s_target_minor_version in k8s_version_matrix

- name: "íŒ¨ì¹˜ ë²„ì „ í™•ì¸ ë””ë²„ê¹…"
  debug:
    msg:
      - "ğŸ“‹ íŒ¨ì¹˜ ë²„ì „ í™•ì¸ ê²°ê³¼:"
      - "  ë§¤íŠ¸ë¦­ìŠ¤ì— ë²„ì „ ì¡´ì¬: {{ k8s_target_minor_version in k8s_version_matrix }}"
      - "  ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „: {{ k8s_available_patches | default([]) | join(', ') }}"
      - "  íŒ¨ì¹˜ ë²„ì „ ê°œìˆ˜: {{ k8s_available_patches | default([]) | length }}"
  when: k8s_need_fallback | default(false)

- name: "í˜„ì¬ ìš”ì²­ëœ íŒ¨ì¹˜ ë²„ì „ í™•ì¸"
  set_fact:
    k8s_requested_patch_version: "{{ k8s_target_version | regex_replace('^v', '') }}"
  when: 
    - k8s_need_fallback | default(false)
    - k8s_target_version is defined
    - k8s_target_version != ""

- name: "ìš”ì²­ëœ ë²„ì „ì´ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸"
  set_fact:
    k8s_requested_version_available: "{{ k8s_requested_patch_version in k8s_available_patches }}"
  when: 
    - k8s_need_fallback | default(false)
    - k8s_requested_patch_version is defined
    - k8s_available_patches is defined

- name: "Fallback ë²„ì „ ì„ íƒ"
  set_fact:
    k8s_fallback_version: "{{ k8s_available_patches[0] if k8s_version_fallback_strategy == 'latest_patch' and k8s_available_patches | length > 0 else k8s_requested_patch_version }}"
  when: 
    - k8s_need_fallback | default(false)
    - k8s_available_patches | length > 0
    - k8s_requested_patch_version is defined
    - not (k8s_requested_version_available | default(false))

- name: "ìš”ì²­ëœ ë²„ì „ê³¼ fallback ë²„ì „ ë¹„êµ"
  debug:
    msg:
      - "ğŸ”„ ë²„ì „ Fallback ì •ë³´:"
      - "  ìš”ì²­ëœ ë²„ì „: {{ k8s_requested_patch_version | default('N/A') }}"
      - "  ìš”ì²­ëœ ë²„ì „ ì‚¬ìš© ê°€ëŠ¥: {{ k8s_requested_version_available | default('N/A') }}"
      - "  ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „: {{ k8s_available_patches | default([]) | join(', ') }}"
      - "  Fallback ì „ëµ: {{ k8s_version_fallback_strategy | default('N/A') }}"
      - "  ì„ íƒëœ Fallback ë²„ì „: {{ k8s_fallback_version | default('N/A') }}"
      - "  Fallback í•„ìš”: {{ not (k8s_requested_version_available | default(true)) }}"
  when: k8s_need_fallback | default(false)

- name: "Fallback ë²„ì „ ì ìš©"
  set_fact:
    k8s_target_version: "v{{ k8s_fallback_version }}"
    k8s_version_fallback_applied: true
  when: 
    - k8s_need_fallback | default(false)
    - k8s_fallback_version is defined
    - k8s_fallback_version != ""
    - k8s_requested_patch_version is defined
    - not (k8s_requested_version_available | default(true))

- name: "Fallback ì ìš© ì•Œë¦¼"
  debug:
    msg:
      - "âš ï¸  íŒ¨í‚¤ì§€ ë²„ì „ Fallbackì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!"
      - "  ì›ë˜ ìš”ì²­ ë²„ì „: {{ k8s_requested_patch_version | default('N/A') }}"
      - "  ì ìš©ëœ ë²„ì „: {{ k8s_fallback_version | default('N/A') }}"
      - "  ìƒˆë¡œìš´ íƒ€ê²Ÿ ë²„ì „: {{ k8s_target_version | default('N/A') }}"
      - "  ì´ìœ : ìš”ì²­ëœ ë²„ì „ì´ ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „ ë¦¬ìŠ¤íŠ¸ì— ì—†ìŠµë‹ˆë‹¤."
  when: k8s_version_fallback_applied | default(false)

- name: "Fallback ë¯¸ì ìš© ì•Œë¦¼"
  debug:
    msg:
      - "âœ… ìš”ì²­ëœ ë²„ì „ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤."
      - "  ì‚¬ìš© ë²„ì „: {{ k8s_target_version | default('N/A') }}"
      - "  ì´ìœ : ìš”ì²­ëœ ë²„ì „ì´ ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
  when: 
    - k8s_version_fallback_enabled | default(false)
    - k8s_need_fallback | default(false)
    - k8s_requested_version_available | default(true)
    - not (k8s_version_fallback_applied | default(false))

# ë²„ì „ ë¹„êµ ë° ê²€ì¦
- name: "í˜„ì¬ ë²„ì „ê³¼ ëª©í‘œ ë²„ì „ ë¹„êµ"
  debug:
    msg:
      - "í˜„ì¬ ë²„ì „: {{ k8s_current_version }}"
      - "ëª©í‘œ ë²„ì „: {{ k8s_target_version }}"

- name: "ë™ì¼ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ í™•ì¸"
  debug:
    msg: "í˜„ì¬ ë²„ì „ê³¼ ëª©í‘œ ë²„ì „ì´ ë™ì¼í•©ë‹ˆë‹¤. ì—…ê·¸ë ˆì´ë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
  when: k8s_current_version == k8s_target_version

- name: "ë‹¤ìš´ê·¸ë ˆì´ë“œ ë°©ì§€"
  fail:
    msg: "ë‹¤ìš´ê·¸ë ˆì´ë“œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í˜„ì¬: {{ k8s_current_version }}, ëª©í‘œ: {{ k8s_target_version }}"
  when: 
    - k8s_current_version != k8s_target_version
    - k8s_current_version is version(k8s_target_version, '>')

# ìŠ¤í‚µ ì¡°ê±´ ì²˜ë¦¬
- name: "ì—…ê·¸ë ˆì´ë“œ ìŠ¤í‚µ ì„¤ì •"
  set_fact:
    k8s_skip_upgrade: true
  when: k8s_current_version == k8s_target_version

- name: "ì—…ê·¸ë ˆì´ë“œ ì§„í–‰ ì„¤ì •"
  set_fact:
    k8s_skip_upgrade: false
  when: k8s_current_version != k8s_target_version

# ëª©í‘œ ë²„ì „ ì •ë³´ í‘œì‹œ
- name: "ëª©í‘œ ë²„ì „ ì •ë³´ í‘œì‹œ"
  debug:
    msg:
      - "=== ì—…ê·¸ë ˆì´ë“œ ê³„íš ==="
      - "í˜„ì¬ ë²„ì „: {{ k8s_current_version }}"
      - "ëª©í‘œ ë²„ì „: {{ k8s_target_version }}"
      - "ì—…ê·¸ë ˆì´ë“œ í•„ìš”: {{ not k8s_skip_upgrade }}"
      - "ê°•ì œ ëª¨ë“œ: {{ k8s_force_version }}"
      - "OS í˜¸í™˜ì„±: âœ“"

# ì¶”ê°€ êµ¬ì„± ìš”ì†Œ ë²„ì „ ì •ë³´
- name: "ê´€ë ¨ êµ¬ì„± ìš”ì†Œ ë²„ì „ ì •ë³´"
  debug:
    msg:
      - "=== ê´€ë ¨ êµ¬ì„± ìš”ì†Œ ë²„ì „ ==="
      - "etcd: {{ k8s_version_matrix[k8s_target_minor_version].etcd_version | default('N/A') }}"
      - "cri-o: {{ k8s_version_matrix[k8s_target_minor_version].crio_version | default('N/A') }}"
  when: k8s_target_minor_version in k8s_version_matrix

- name: "ëª©í‘œ ë²„ì „ ê²°ì • ì™„ë£Œ"
  debug:
    msg: "ëª©í‘œ ë²„ì „ ê²°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: {{ k8s_target_version }}" 
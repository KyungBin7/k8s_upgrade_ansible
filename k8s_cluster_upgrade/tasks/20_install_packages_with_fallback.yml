---
# 1.30 ì´í›„ ë²„ì „ì— ëŒ€í•œ Fallback íŒ¨í‚¤ì§€ ì„¤ì¹˜/ì—…ê·¸ë ˆì´ë“œ

- name: "Fallback íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œì‘"
  debug:
    msg: 
      - "ğŸ”„ Fallback íŒ¨í‚¤ì§€ ì„¤ì¹˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤"
      - "  ìš”ì²­ëœ íŒ¨í‚¤ì§€: {{ k8s_packages_to_install | join(', ') }}"
      - "  ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „: {{ k8s_available_patches | default([]) | join(', ') }}"

# í˜„ì¬ ìš”ì²­ëœ íŒ¨í‚¤ì§€ì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
- name: "íŒ¨í‚¤ì§€ ë²„ì „ ì •ë³´ ì¶”ì¶œ"
  set_fact:
    k8s_package_base_names: "{{ k8s_packages_to_install | map('regex_replace', '=.*', '') | list }}"
    k8s_target_minor_version: "{{ k8s_target_version | regex_replace('^v', '') | regex_replace('\\.[0-9]+$', '') }}"

- name: "íŒ¨í‚¤ì§€ ì •ë³´ ë””ë²„ê·¸"
  debug:
    msg:
      - "íŒ¨í‚¤ì§€ ê¸°ë³¸ ì´ë¦„: {{ k8s_package_base_names | join(', ') }}"
      - "íƒ€ê²Ÿ ë§ˆì´ë„ˆ ë²„ì „: {{ k8s_target_minor_version }}"

# yum ì €ì¥ì†Œ ì„¤ì • (ì„ íƒëœ repo ì‚¬ìš©)
- name: "Kubernetes yum ì €ì¥ì†Œ ì„¤ì •"
  yum_repository:
    name: "{{ k8s_selected_repo_config.yum.repo_name }}"
    description: "Kubernetes Repository ({{ 'Official' if k8s_use_official_repo | default(false) else 'Legacy' }})"
    baseurl: "{{ k8s_selected_repo_config.yum.repo_baseurl }}"
    gpgcheck: yes
    gpgkey: "{{ k8s_selected_repo_config.yum.gpg_key }}"
    enabled: yes
    exclude: "kubelet kubeadm kubectl cri-tools kubernetes-cni"
  when: 
    - k8s_detected_package_manager == "yum"
    - not k8s_repo_configured

# apt ì €ì¥ì†Œ ì„¤ì • (ì„ íƒëœ repo ì‚¬ìš©)
- name: "Kubernetes GPG í‚¤ ì¶”ê°€"
  get_url:
    url: "{{ k8s_selected_repo_config.yum.gpg_key if k8s_use_official_repo | default(false) else 'https://packages.cloud.google.com/apt/doc/apt-key.gpg' }}"
    dest: "{{ k8s_selected_repo_config.apt.keyring_path }}"
    mode: '0644'
  when: 
    - k8s_detected_package_manager == "apt"
    - not k8s_repo_configured

- name: "Kubernetes apt ì €ì¥ì†Œ ì„¤ì •"
  apt_repository:
    repo: "deb [signed-by={{ k8s_selected_repo_config.apt.keyring_path }}] {{ k8s_selected_repo_config.apt.repo_url }} {{ 'kubernetes-xenial' if not k8s_use_official_repo | default(false) else '' }} main"
    state: present
    filename: kubernetes
  when: 
    - k8s_detected_package_manager == "apt"
    - not k8s_repo_configured

# íŒ¨í‚¤ì§€ ì–¸í™€ë“œ (apt)
- name: "íŒ¨í‚¤ì§€ ì–¸í™€ë“œ (apt)"
  command: "apt-mark unhold {{ item }}"
  loop: "{{ k8s_package_base_names }}"
  when: 
    - k8s_detected_package_manager == "apt"
    - k8s_package_hold
  ignore_errors: true

# ì—¬ëŸ¬ íŒ¨ì¹˜ ë²„ì „ì„ ìˆœì„œëŒ€ë¡œ ì‹œë„í•˜ëŠ” ë¡œì§
- name: "ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „ìœ¼ë¡œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„"
  include_tasks: try_install_version.yml
  loop: "{{ k8s_available_patches | default([]) }}"
  loop_control:
    loop_var: patch_version
  when: 
    - k8s_available_patches | default([]) | length > 0
    - k8s_package_install_success is not defined

# ëª¨ë“  íŒ¨ì¹˜ ë²„ì „ ì‹¤íŒ¨ ì‹œ ê²½ê³ 
- name: "ëª¨ë“  íŒ¨ì¹˜ ë²„ì „ ì„¤ì¹˜ ì‹¤íŒ¨ ê²½ê³ "
  fail:
    msg: 
      - "âŒ ëª¨ë“  ì‚¬ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ ë²„ì „ì— ëŒ€í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
      - "  ì‹œë„í•œ ë²„ì „: {{ k8s_available_patches | default([]) | join(', ') }}"
      - "  íŒ¨í‚¤ì§€: {{ k8s_package_base_names | join(', ') }}"
      - "  ì €ì¥ì†Œ ì„¤ì •ì„ í™•ì¸í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì„¤ì¹˜ ë°©ë²•ì„ ì‹œë„í•´ë³´ì„¸ìš”."
  when: 
    - k8s_available_patches | default([]) | length > 0
    - k8s_package_install_success is not defined

# íŒ¨í‚¤ì§€ í™€ë“œ (apt)
- name: "íŒ¨í‚¤ì§€ í™€ë“œ (apt)"
  command: "apt-mark hold {{ item }}"
  loop: "{{ k8s_package_base_names }}"
  when: 
    - k8s_detected_package_manager == "apt"
    - k8s_package_hold
    - k8s_package_install_success is defined

# ì„¤ì¹˜ëœ ë²„ì „ í™•ì¸
- name: "ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë²„ì „ í™•ì¸ (yum)"
  shell: "yum list installed | grep {{ item }}"
  register: yum_installed_versions
  loop: "{{ k8s_package_base_names }}"
  when: 
    - k8s_detected_package_manager == "yum"
    - k8s_package_install_success is defined
  changed_when: false

- name: "ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë²„ì „ í™•ì¸ (apt)"
  shell: "dpkg -l | grep {{ item }}"
  register: apt_installed_versions
  loop: "{{ k8s_package_base_names }}"
  when: 
    - k8s_detected_package_manager == "apt"
    - k8s_package_install_success is defined
  changed_when: false

- name: "ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë²„ì „ í‘œì‹œ (yum)"
  debug:
    msg: "{{ item.stdout }}"
  loop: "{{ yum_installed_versions.results }}"
  when: 
    - k8s_detected_package_manager == "yum"
    - yum_installed_versions is defined
  loop_control:
    label: "{{ item.item }}"

- name: "ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë²„ì „ í‘œì‹œ (apt)"
  debug:
    msg: "{{ item.stdout }}"
  loop: "{{ apt_installed_versions.results }}"
  when: 
    - k8s_detected_package_manager == "apt"
    - apt_installed_versions is defined
  loop_control:
    label: "{{ item.item }}"

- name: "Fallback íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
  debug:
    msg: 
      - "âœ… Fallback íŒ¨í‚¤ì§€ ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
      - "  ì„±ê³µí•œ ë²„ì „: {{ k8s_successful_version | default('N/A') }}"
  when: k8s_package_install_success is defined 
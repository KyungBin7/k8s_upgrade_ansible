---
# ë¡¤ë°± ì™„ë£Œ í›„ ì •ë¦¬ ì‘ì—…

- name: "ì •ë¦¬ ì‘ì—… ì‹œì‘"
  debug:
    msg: "ë¡¤ë°± ì™„ë£Œ í›„ ì •ë¦¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤"

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
- name: "ì„ì‹œ íŒŒì¼ ëª©ë¡ í™•ì¸"
  find:
    paths:
      - /tmp
      - /var/tmp
    patterns:
      - "k8s-rollback-*"
      - "rollback-*.tmp"
      - "kubeadm-*"
    age: "1h"
  register: temp_files

- name: "ì„ì‹œ íŒŒì¼ ì •ë¦¬"
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ temp_files.files }}"
  loop_control:
    label: "{{ item.path }}"
  ignore_errors: true

# ë¡¤ë°± ê³¼ì •ì—ì„œ ìƒì„±ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (ì„ íƒì )
- name: "ë¡¤ë°± ì¤‘ ìƒì„±ëœ ë°±ì—… íŒŒì¼ í™•ì¸"
  find:
    paths:
      - "{{ k8s_config_dir | dirname }}"
      - /etc/systemd/system
    patterns:
      - "*.rollback-backup.*"
      - "*.backup.*"
    age: "{{ k8s_cleanup_backup_age | default('1d') }}"
  register: rollback_backup_files
  when: k8s_cleanup_rollback_backups | default(false)

- name: "ë¡¤ë°± ë°±ì—… íŒŒì¼ ì •ë¦¬"
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ rollback_backup_files.files }}"
  loop_control:
    label: "{{ item.path }}"
  when: 
    - k8s_cleanup_rollback_backups | default(false)
    - rollback_backup_files is defined
  ignore_errors: true

# ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì •ë¦¬ (ì„ íƒì )
- name: "ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì •ë¦¬"
  shell: |
    if command -v crictl >/dev/null 2>&1; then
      crictl rmi --prune 2>/dev/null || true
    fi
    if command -v docker >/dev/null 2>&1; then
      docker image prune -f 2>/dev/null || true
    fi
  when: k8s_cleanup_container_images | default(false)
  ignore_errors: true

# íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬
- name: "íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬ (YUM)"
  shell: |
    yum clean all 2>/dev/null || true
  when: 
    - k8s_cleanup_package_cache | default(false)
    - ansible_os_family == "RedHat"
  ignore_errors: true

- name: "íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬ (APT)"
  shell: |
    apt-get clean 2>/dev/null || true
    apt-get autoclean 2>/dev/null || true
  when: 
    - k8s_cleanup_package_cache | default(false)
    - ansible_os_family == "Debian"
  ignore_errors: true

# ë¡œê·¸ íŒŒì¼ ì••ì¶• (ì˜¤ë˜ëœ ê²ƒë§Œ)
- name: "ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ í™•ì¸"
  find:
    paths:
      - /var/log
      - /var/log/pods
    patterns:
      - "*.log"
    age: "{{ k8s_log_compress_age | default('7d') }}"
    size: "{{ k8s_log_compress_size | default('100m') }}"
  register: old_log_files
  when: k8s_compress_old_logs | default(false)

- name: "ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ ì••ì¶•"
  shell: |
    gzip "{{ item.path }}" 2>/dev/null || true
  loop: "{{ old_log_files.files }}"
  loop_control:
    label: "{{ item.path }}"
  when: 
    - k8s_compress_old_logs | default(false)
    - old_log_files is defined
  ignore_errors: true

# systemd ì €ë„ ì •ë¦¬
- name: "systemd ì €ë„ í¬ê¸° ì •ë¦¬"
  shell: |
    journalctl --vacuum-time={{ k8s_journal_retention | default('7d') }}
    journalctl --vacuum-size={{ k8s_journal_max_size | default('500M') }}
  when: k8s_cleanup_systemd_journal | default(false)
  ignore_errors: true

# kubelet ë¡œê·¸ ì •ë¦¬
- name: "kubelet ë¡œê·¸ íŒŒì¼ í™•ì¸"
  stat:
    path: /var/log/kubelet.log
  register: kubelet_log_stat

- name: "kubelet ë¡œê·¸ ë°±ì—… ë° ì •ë¦¬"
  shell: |
    if [ -f /var/log/kubelet.log ] && [ $(stat -f%z /var/log/kubelet.log 2>/dev/null || stat -c%s /var/log/kubelet.log 2>/dev/null) -gt 104857600 ]; then
      cp /var/log/kubelet.log /var/log/kubelet.log.$(date +%Y%m%d-%H%M%S)
      > /var/log/kubelet.log
    fi
  when: 
    - k8s_cleanup_kubelet_logs | default(false)
    - kubelet_log_stat.stat.exists | default(false)
  ignore_errors: true

# ë¡¤ë°± ìƒíƒœ íŒŒì¼ ìƒì„±
- name: "ë¡¤ë°± ì™„ë£Œ ìƒíƒœ íŒŒì¼ ìƒì„±"
  copy:
    content: |
      # Kubernetes í´ëŸ¬ìŠ¤í„° ë¡¤ë°± ì™„ë£Œ ì •ë³´
      ë¡¤ë°± ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
      í˜¸ìŠ¤íŠ¸ëª…: {{ inventory_hostname }}
      ë…¸ë“œ ì—­í• : {{ k8s_detected_role }}
      ë°±ì—… íƒ€ì„ìŠ¤íƒ¬í”„: {{ k8s_backup_timestamp }}
      ë¡¤ë°± ëª¨ë“œ: {{ k8s_rollback_mode }}
      ë³µì›ëœ ë²„ì „: {{ restored_version.stdout | default('Unknown') }}
      OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      ë¡¤ë°± ì‹¤í–‰ì: {{ ansible_user_id }}
    dest: "{{ k8s_backup_dir }}/rollback-{{ k8s_backup_timestamp }}-complete.txt"
    mode: '0644'

# ì¬ë¶€íŒ… í•„ìš” ì—¬ë¶€ í™•ì¸
- name: "ì¬ë¶€íŒ… í•„ìš” ì—¬ë¶€ í™•ì¸"
  stat:
    path: /var/run/reboot-required
  register: reboot_required
  when: ansible_os_family == "Debian"

- name: "ì¬ë¶€íŒ… ê¶Œì¥ ì‚¬í•­ (Ubuntu/Debian)"
  debug:
    msg: 
      - "âš ï¸  ì‹œìŠ¤í…œ ì¬ë¶€íŒ…ì´ ê¶Œì¥ë©ë‹ˆë‹¤"
      - "ìˆ˜ë™ìœ¼ë¡œ ì¬ë¶€íŒ…ì„ ì‹¤í–‰í•˜ì„¸ìš”: sudo reboot"
  when: 
    - ansible_os_family == "Debian"
    - reboot_required.stat.exists | default(false)

# ì„œë¹„ìŠ¤ ìƒíƒœ ìµœì¢… í™•ì¸
- name: "ì£¼ìš” ì„œë¹„ìŠ¤ ìµœì¢… ìƒíƒœ í™•ì¸"
  systemd:
    name: "{{ item }}"
  register: final_service_check
  loop:
    - kubelet
    - "{{ k8s_container_runtime }}"
  failed_when: false

- name: "ì„œë¹„ìŠ¤ ìƒíƒœ ìš”ì•½"
  debug:
    msg:
      - "==================== ì„œë¹„ìŠ¤ ìƒíƒœ ìš”ì•½ ===================="
      - "kubelet: {{ final_service_check.results[0].status.ActiveState if final_service_check.results[0].status is defined else 'Unknown' }}"
      - "{{ k8s_container_runtime }}: {{ final_service_check.results[1].status.ActiveState if final_service_check.results[1].status is defined else 'Unknown' }}"
      - "=========================================================="

# ì •ë¦¬ ì™„ë£Œ ìš”ì•½
- name: "ì •ë¦¬ ì‘ì—… ì™„ë£Œ ìš”ì•½"
  debug:
    msg:
      - "==================== ì •ë¦¬ ì‘ì—… ì™„ë£Œ ===================="
      - "ì„ì‹œ íŒŒì¼ ì •ë¦¬: {{ temp_files.files | length }}ê°œ íŒŒì¼"
      - "ì •ë¦¬ ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}"
      - "ìƒíƒœ íŒŒì¼: {{ k8s_backup_dir }}/rollback-{{ k8s_backup_timestamp }}-complete.txt"
      - "=========================================================="

# ì‚¬ìš©ì ì•ˆë‚´ ë©”ì‹œì§€
- name: "ë¡¤ë°± ì™„ë£Œ ì•ˆë‚´"
  debug:
    msg:
      - "ğŸ‰ Kubernetes í´ëŸ¬ìŠ¤í„° ë¡¤ë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
      - ""
      - "ğŸ“‹ í™•ì¸ ì‚¬í•­:"
      - "  - kubectl get nodes"
      - "  - kubectl get pods --all-namespaces"
      - "  - systemctl status kubelet"
      - ""
      - "ğŸ“ ìƒíƒœ íŒŒì¼: {{ k8s_backup_dir }}/rollback-{{ k8s_backup_timestamp }}-complete.txt"
      - "ğŸ“Š ë³µì›ëœ ë²„ì „: {{ restored_version.stdout | default('í™•ì¸ í•„ìš”') }}"
      - ""
      - "âš ï¸  ë¡¤ë°± í›„ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì •ìƒ ë™ì‘ì„ í™•ì¸í•´ì£¼ì„¸ìš”."

- name: "ì •ë¦¬ ì‘ì—… ì™„ë£Œ"
  debug:
    msg: "ë¡¤ë°± ì •ë¦¬ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤" 
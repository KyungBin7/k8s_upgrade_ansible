---
# Kubernetes í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ í”Œë ˆì´ë¶
# ì‚¬ìš©ë²•: ansible-playbook -i inventory/hosts playbook.yml

- name: "Kubernetes í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ"
  hosts: k8s_cluster
  become: yes
  gather_facts: yes
  serial: "{{ k8s_upgrade_strategy == 'all-at-once' | ternary('100%', 1) }}"
  
  vars:
    # ê¸°ë³¸ ì„¤ì • - ìë™ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
    k8s_current_version: ""  # ìë™ ê°ì§€
    k8s_target_version: ""   # ë‹¤ìŒ ë§ˆì´ë„ˆ ë²„ì „ìœ¼ë¡œ ìë™ ì„¤ì •
    k8s_force_version: false
    
    # ì—…ê·¸ë ˆì´ë“œ ì „ëµ
    k8s_upgrade_strategy: "rolling"  # rolling ë˜ëŠ” all-at-once
    k8s_upgrade_timeout: 900  # 15ë¶„
    k8s_upgrade_drain_timeout: 600  # 10ë¶„
    k8s_upgrade_skip_drain: false
    k8s_upgrade_skip_cordon: false
    
    # ë°±ì—… ì„¤ì •
    k8s_backup_enabled: true
    k8s_backup_dir: "/opt/k8s-backup"
    k8s_backup_retention_days: 7
    
    # ê²€ì¦ ì„¤ì •
    k8s_verify_upgrade: true
    k8s_health_check_retries: 30
    k8s_health_check_delay: 10
    
    # ë¡œê·¸ ì„¤ì •
    k8s_log_level: "info"
    k8s_log_file: "/var/log/k8s-upgrade.log"
    
    # CRI-O ëŸ°íƒ€ì„ ì„¤ì •
    k8s_container_runtime: "crio"

  pre_tasks:
    - name: "ì—…ê·¸ë ˆì´ë“œ ì‹œì‘ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          ğŸš€ Kubernetes í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ì‹œì‘
          ==========================================
          ğŸ“ íƒ€ê²Ÿ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ• ì‹œì‘ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ”§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ’¾ ë©”ëª¨ë¦¬: {{ ansible_memtotal_mb }}MB
          ğŸ’¿ ë””ìŠ¤í¬: {{ ansible_mounts[0].size_available }}
          ğŸ”— IP: {{ ansible_default_ipv4.address }}
          ==========================================
      tags: always

    - name: "ì—…ê·¸ë ˆì´ë“œ ì‚¬ì „ ì•Œë¦¼"
      pause:
        prompt: |
          âš ï¸  ì¤‘ìš”: Kubernetes í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
          
          ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸:
          âœ… í´ëŸ¬ìŠ¤í„° ë°±ì—…ì´ ì¤€ë¹„ë˜ì—ˆë‚˜ìš”?
          âœ… ì—…ê·¸ë ˆì´ë“œ ì¤‘ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì„ ì˜ˆìƒí•˜ê³  ìˆë‚˜ìš”?
          âœ… ë¬¸ì œ ë°œìƒ ì‹œ ë¡¤ë°± ê³„íšì´ ìˆë‚˜ìš”?
          
          ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš” (Ctrl+Cë¡œ ì·¨ì†Œ)
      when: 
        - k8s_interactive_mode | default(false)
        - not ansible_check_mode
      tags: always

  roles:
    - k8s_cluster_upgrade

  post_tasks:
    - name: "ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          ğŸ‰ Kubernetes í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!
          ==========================================
          ğŸ“ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ• ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ“Š ì´ì „ ë²„ì „: {{ k8s_current_version | default('ê°ì§€ ì‹¤íŒ¨') }}
          ğŸ“Š í˜„ì¬ ë²„ì „: {{ k8s_target_version | default('ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨') }}
          ğŸ’¾ ë°±ì—… ìœ„ì¹˜: {{ k8s_current_backup_dir | default('ë°±ì—… ì—†ìŒ') }}
          ==========================================
      tags: always

    - name: "ì¬ë¶€íŒ… í•„ìš” ì—¬ë¶€ ì•Œë¦¼"
      debug:
        msg: |
          âš ï¸  ì•Œë¦¼: ì‹œìŠ¤í…œ ì¬ë¶€íŒ…ì´ ê¶Œì¥ë©ë‹ˆë‹¤.
          ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì¬ë¶€íŒ…í•˜ì„¸ìš”:
          sudo systemctl reboot
      when: 
        - ansible_os_family == "RedHat" and reboot_required_yum is defined and reboot_required_yum.rc == 1
        - or ansible_os_family == "Debian" and reboot_required_apt is defined and reboot_required_apt.stat.exists
      tags: always

  handlers:
    - name: restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes
      
    - name: restart crio
      systemd:
        name: crio
        state: restarted
        enabled: yes 
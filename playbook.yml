---
# Kubernetes í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ í”Œë ˆì´ë¶
# ì‚¬ìš©ë²•: ansible-playbook -i inventory/hosts playbook.yml

# 1ë‹¨ê³„: ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ (ìˆœì°¨ì )
- name: "ğŸ—ï¸  Kubernetes ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ"
  hosts: control_plane
  become: yes
  gather_facts: yes
  serial: 1  # ë§ˆìŠ¤í„° ë…¸ë“œëŠ” í•­ìƒ í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ
  
  vars:
    # ê¸°ë³¸ ì„¤ì • - ìë™ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
    k8s_current_version: ""  # ìë™ ê°ì§€
    k8s_target_version: ""   # ë‹¤ìŒ ë§ˆì´ë„ˆ ë²„ì „ìœ¼ë¡œ ìë™ ì„¤ì •
    k8s_force_version: false
    k8s_upgrade_phase: "control_plane"
    
    # ì—…ê·¸ë ˆì´ë“œ ì „ëµ
    k8s_upgrade_strategy: "rolling"  # rolling ë˜ëŠ” all-at-once
    k8s_upgrade_timeout: 900  # 15ë¶„
    k8s_upgrade_drain_timeout: 600  # 10ë¶„
    k8s_upgrade_skip_drain: false
    k8s_upgrade_skip_cordon: false
    
    # ë°±ì—… ì„¤ì •
    k8s_backup_enabled: true
    k8s_backup_dir: "/opt/k8s-backup"
    k8s_backup_retention_days: 7
    
    # ê²€ì¦ ì„¤ì •
    k8s_verify_upgrade: true
    k8s_health_check_retries: 30
    k8s_health_check_delay: 10
    
    # ë¡œê·¸ ì„¤ì •
    k8s_log_level: "info"
    k8s_log_file: "/var/log/k8s-upgrade.log"
    
    # CRI-O ëŸ°íƒ€ì„ ì„¤ì •
    k8s_container_runtime: "crio"

  pre_tasks:
    - name: "ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì‹œì‘ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          ğŸ—ï¸  Kubernetes ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì‹œì‘
          ==========================================
          ğŸ“ íƒ€ê²Ÿ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ• ì‹œì‘ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ”§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ’¾ ë©”ëª¨ë¦¬: {{ ansible_memtotal_mb }}MB
          ğŸ’¿ ë””ìŠ¤í¬: {{ ansible_mounts[0].size_available }}
          ğŸ”— IP: {{ ansible_default_ipv4.address }}
          âš ï¸  ìˆœì„œ: ë§ˆìŠ¤í„° ë…¸ë“œë“¤ì„ í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
          ==========================================
      tags: always

    - name: "ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì‚¬ì „ ì•Œë¦¼"
      pause:
        prompt: |
          âš ï¸  ì¤‘ìš”: Kubernetes ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
          
          ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸:
          âœ… í´ëŸ¬ìŠ¤í„° ë°±ì—…ì´ ì¤€ë¹„ë˜ì—ˆë‚˜ìš”?
          âœ… etcd ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆë‚˜ìš”?
          âœ… ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì¤‘ í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ì´ ì œí•œë©ë‹ˆë‹¤.
          
          ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš” (Ctrl+Cë¡œ ì·¨ì†Œ)
      when: 
        - k8s_interactive_mode | default(false)
        - not ansible_check_mode
        - inventory_hostname == groups['control_plane'][0]  # ì²« ë²ˆì§¸ ë§ˆìŠ¤í„°ì—ì„œë§Œ
      tags: always

  roles:
    - k8s_cluster_upgrade

  post_tasks:
    - name: "ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          âœ… ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!
          ==========================================
          ğŸ“ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ• ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ“Š ì´ì „ ë²„ì „: {{ k8s_current_version | default('ê°ì§€ ì‹¤íŒ¨') }}
          ğŸ“Š í˜„ì¬ ë²„ì „: {{ k8s_target_version | default('ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨') }}
          ğŸ’¾ ë°±ì—… ìœ„ì¹˜: {{ k8s_current_backup_dir | default('ë°±ì—… ì—†ìŒ') }}
          â­ï¸  ë‹¤ìŒ: ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ëŒ€ê¸° ì¤‘...
          ==========================================
      tags: always

  handlers:
    - name: restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes
      
    - name: restart crio
      systemd:
        name: crio
        state: restarted
        enabled: yes

# 2ë‹¨ê³„: ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ (ìˆœì°¨ì , ë§ˆìŠ¤í„° ì™„ë£Œ í›„)
- name: "ğŸš€ Kubernetes ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ"
  hosts: workers
  become: yes
  gather_facts: yes
  serial: 1  # ì›Œì»¤ ë…¸ë“œëŠ” í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ (ì„œë¹„ìŠ¤ ë‹¤ìš´íƒ€ì„ ë°©ì§€)
  
  vars:
    # ê¸°ë³¸ ì„¤ì • - ë§ˆìŠ¤í„°ì™€ ë™ì¼í•œ ë²„ì „ìœ¼ë¡œ
    k8s_current_version: ""  # ìë™ ê°ì§€
    k8s_target_version: ""   # ë§ˆìŠ¤í„°ì™€ ë™ì¼í•œ ë²„ì „ìœ¼ë¡œ ì„¤ì •
    k8s_force_version: false
    k8s_upgrade_phase: "worker"
    
    # ì—…ê·¸ë ˆì´ë“œ ì „ëµ - ì›Œì»¤ëŠ” ë” ì‹ ì¤‘í•˜ê²Œ
    k8s_upgrade_strategy: "rolling"
    k8s_upgrade_timeout: 600  # 10ë¶„ (ì›Œì»¤ëŠ” ë§ˆìŠ¤í„°ë³´ë‹¤ ë¹ ë¦„)
    k8s_upgrade_drain_timeout: 300  # 5ë¶„
    k8s_upgrade_skip_drain: false  # ì›Œì»¤ëŠ” ë°˜ë“œì‹œ drain ìˆ˜í–‰
    k8s_upgrade_skip_cordon: false
    
    # ë°±ì—… ì„¤ì • (ì›Œì»¤ëŠ” ê°„ì†Œí™”)
    k8s_backup_enabled: false  # ì›Œì»¤ëŠ” ìƒíƒœê°€ ì—†ìœ¼ë¯€ë¡œ ë°±ì—… ë¶ˆí•„ìš”
    k8s_backup_dir: "/opt/k8s-backup"
    k8s_backup_retention_days: 7
    
    # ê²€ì¦ ì„¤ì •
    k8s_verify_upgrade: true
    k8s_health_check_retries: 20
    k8s_health_check_delay: 15  # ì›Œì»¤ëŠ” ë” ìì£¼ ì²´í¬
    
    # ë¡œê·¸ ì„¤ì •
    k8s_log_level: "info"
    k8s_log_file: "/var/log/k8s-upgrade.log"
    
    # CRI-O ëŸ°íƒ€ì„ ì„¤ì •
    k8s_container_runtime: "crio"

  pre_tasks:
    - name: "ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì‹œì‘ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          ğŸš€ Kubernetes ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì‹œì‘
          ==========================================
          ğŸ“ íƒ€ê²Ÿ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ• ì‹œì‘ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ”§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ’¾ ë©”ëª¨ë¦¬: {{ ansible_memtotal_mb }}MB
          ğŸ’¿ ë””ìŠ¤í¬: {{ ansible_mounts[0].size_available }}
          ğŸ”— IP: {{ ansible_default_ipv4.address }}
          âš ï¸  ìˆœì„œ: ì›Œì»¤ ë…¸ë“œë“¤ì„ í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
          ğŸ›¡ï¸  ë³´ì¥: ì´ì „ ì›Œì»¤ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ í›„ ë‹¤ìŒ ì§„í–‰
          ==========================================
      tags: always

    - name: "ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì‚¬ì „ ì•Œë¦¼"
      pause:
        prompt: |
          âš ï¸  ì¤‘ìš”: Kubernetes ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
          
          ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸:
          âœ… ë§ˆìŠ¤í„° ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œê°€ ì™„ë£Œë˜ì—ˆë‚˜ìš”?
          âœ… ì›Œì»¤ ë…¸ë“œê°€ ìˆœì°¨ì ìœ¼ë¡œ í•˜ë‚˜ì”© ì—…ê·¸ë ˆì´ë“œë©ë‹ˆë‹¤.
          âœ… íŒŒë“œê°€ ë‹¤ë¥¸ ë…¸ë“œë¡œ ì´ì „ë©ë‹ˆë‹¤.
          
          ê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš” (Ctrl+Cë¡œ ì·¨ì†Œ)
      when: 
        - k8s_interactive_mode | default(false)
        - not ansible_check_mode
        - inventory_hostname == groups['workers'][0]  # ì²« ë²ˆì§¸ ì›Œì»¤ì—ì„œë§Œ
      tags: always

    - name: "ë§ˆìŠ¤í„° ë…¸ë“œ ìƒíƒœ í™•ì¸"
      uri:
        url: "https://{{ groups['control_plane'][0] }}:6443/healthz"
        method: GET
        validate_certs: no
        status_code: 200
      delegate_to: "{{ groups['control_plane'][0] }}"
      register: master_health_check
      retries: 5
      delay: 10
      tags: always

  roles:
    - k8s_cluster_upgrade

  post_tasks:
    - name: "ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          âœ… ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!
          ==========================================
          ğŸ“ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ• ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ğŸ“Š ì´ì „ ë²„ì „: {{ k8s_current_version | default('ê°ì§€ ì‹¤íŒ¨') }}
          ğŸ“Š í˜„ì¬ ë²„ì „: {{ k8s_target_version | default('ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨') }}
          ğŸ”„ ë‹¤ìŒ: ë‹¤ìŒ ì›Œì»¤ ë…¸ë“œ ì—…ê·¸ë ˆì´ë“œ ëŒ€ê¸° ì¤‘...
          ==========================================
      tags: always

    - name: "ìµœì¢… í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸"
      command: kubectl get nodes -o wide
      register: final_cluster_status
      delegate_to: "{{ groups['control_plane'][0] }}"
      when: inventory_hostname == groups['workers'][-1]  # ë§ˆì§€ë§‰ ì›Œì»¤ì—ì„œë§Œ
      tags: always

    - name: "ìµœì¢… í´ëŸ¬ìŠ¤í„° ìƒíƒœ í‘œì‹œ"
      debug:
        msg: |
          ==========================================
          ğŸ‰ ì „ì²´ í´ëŸ¬ìŠ¤í„° ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!
          ==========================================
          {{ final_cluster_status.stdout }}
          ==========================================
      when: 
        - inventory_hostname == groups['workers'][-1]  # ë§ˆì§€ë§‰ ì›Œì»¤ì—ì„œë§Œ
        - final_cluster_status is defined
      tags: always

    - name: "ì¬ë¶€íŒ… í•„ìš” ì—¬ë¶€ ì•Œë¦¼"
      debug:
        msg: |
          âš ï¸  ì•Œë¦¼: ì‹œìŠ¤í…œ ì¬ë¶€íŒ…ì´ ê¶Œì¥ë©ë‹ˆë‹¤.
          ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì¬ë¶€íŒ…í•˜ì„¸ìš”:
          sudo systemctl reboot
      when: 
        - ansible_os_family == "RedHat" and reboot_required_yum is defined and reboot_required_yum.rc == 1
        - or ansible_os_family == "Debian" and reboot_required_apt is defined and reboot_required_apt.stat.exists
      tags: always

  handlers:
    - name: restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes
      
    - name: restart crio
      systemd:
        name: crio
        state: restarted
        enabled: yes 
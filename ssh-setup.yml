---
# SSH í‚¤ ìƒì„± ë° ë°°í¬ í”Œë ˆì´ë¶
# ì‚¬ìš©ë²•: ansible-playbook ssh-setup.yml -k

- name: "SSH í‚¤ ìƒì„± ë° ë°°í¬"
  hosts: k8s_cluster
  gather_facts: false
  
  vars:
    ssh_key_path: "~/.ssh/id_rsa"
    ssh_key_comment: "ansible-k8s-cluster"
    ssh_key_bits: 3072
    
  tasks:
    - name: "SSH í‚¤ ìƒì„± ì‹œì‘ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          ğŸ”‘ SSH í‚¤ ìƒì„± ë° ë°°í¬ ì‹œì‘
          ==========================================
          ğŸ¯ ëŒ€ìƒ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ‘¤ ì‚¬ìš©ì: {{ ansible_user }}
          ğŸ”‘ í‚¤ ê²½ë¡œ: {{ ssh_key_path }}
          ==========================================
      delegate_to: localhost
      run_once: true

    - name: "SSH ë””ë ‰í„°ë¦¬ ìƒì„±"
      file:
        path: "{{ ssh_key_path | dirname }}"
        state: directory
        mode: '0700'
      delegate_to: localhost
      run_once: true

    - name: "ê¸°ì¡´ SSH í‚¤ í™•ì¸"
      stat:
        path: "{{ ssh_key_path }}"
      register: ssh_key_exists
      delegate_to: localhost
      run_once: true

    - name: "ê¸°ì¡´ SSH í‚¤ ë°±ì—…"
      copy:
        src: "{{ ssh_key_path }}"
        dest: "{{ ssh_key_path }}.backup.{{ ansible_date_time.epoch }}"
      when: ssh_key_exists.stat.exists
      delegate_to: localhost
      run_once: true

    - name: "ê¸°ì¡´ SSH ê³µê°œí‚¤ ë°±ì—…"
      copy:
        src: "{{ ssh_key_path }}.pub"
        dest: "{{ ssh_key_path }}.pub.backup.{{ ansible_date_time.epoch }}"
      when: ssh_key_exists.stat.exists
      delegate_to: localhost
      run_once: true
      ignore_errors: true

    - name: "ìƒˆ SSH í‚¤ ìƒì„±"
      openssh_keypair:
        path: "{{ ssh_key_path }}"
        type: rsa
        size: "{{ ssh_key_bits }}"
        comment: "{{ ssh_key_comment }}"
        force: true
      delegate_to: localhost
      run_once: true

    - name: "ìƒì„±ëœ SSH ê³µê°œí‚¤ ì½ê¸°"
      slurp:
        src: "{{ ssh_key_path }}.pub"
      register: ssh_public_key
      delegate_to: localhost
      run_once: true

    - name: "SSH ê³µê°œí‚¤ ë‚´ìš© í‘œì‹œ"
      debug:
        msg: |
          ìƒì„±ëœ SSH ê³µê°œí‚¤:
          {{ ssh_public_key.content | b64decode }}
      delegate_to: localhost
      run_once: true

    - name: "íƒ€ê²Ÿ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸"
      wait_for_connection:
        delay: 1
        timeout: 10
      ignore_errors: true

    - name: "íƒ€ê²Ÿ ì„œë²„ SSH ë””ë ‰í„°ë¦¬ ìƒì„±"
      file:
        path: "~{{ ansible_user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: "SSH ê³µê°œí‚¤ ë°°í¬"
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ ssh_public_key.content | b64decode }}"
        comment: "{{ ssh_key_comment }}"
        exclusive: false
      register: key_deploy_result

    - name: "SSH í‚¤ ë°°í¬ ê²°ê³¼"
      debug:
        msg: |
          ğŸ“ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ‘¤ ì‚¬ìš©ì: {{ ansible_user }}
          âœ… ìƒíƒœ: {{ 'ì„±ê³µ' if key_deploy_result.changed else 'ì´ë¯¸ ì¡´ì¬' }}

- name: "SSH í‚¤ ë°°í¬ ì™„ë£Œ ë° í…ŒìŠ¤íŠ¸"
  hosts: k8s_cluster
  gather_facts: false
  
  tasks:
    - name: "SSH í‚¤ ê¸°ë°˜ ì—°ê²° í…ŒìŠ¤íŠ¸"
      ping:
      register: ssh_test_result

    - name: "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼"
      debug:
        msg: |
          ==========================================
          ğŸ‰ SSH í‚¤ ë°°í¬ ì™„ë£Œ!
          ==========================================
          ğŸ“ í˜¸ìŠ¤íŠ¸: {{ inventory_hostname }}
          ğŸ”— ì—°ê²° ìƒíƒœ: {{ 'ì„±ê³µ' if ssh_test_result.ping == 'pong' else 'ì‹¤íŒ¨' }}
          ==========================================

    - name: "ì „ì²´ ì™„ë£Œ ì•Œë¦¼"
      debug:
        msg: |
          ==========================================
          âœ… ëª¨ë“  ë…¸ë“œì— SSH í‚¤ ë°°í¬ ì™„ë£Œ!
          ==========================================
          
          ì´ì œ íŒ¨ìŠ¤ì›Œë“œ ì—†ì´ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
          ansible all -m ping
          
          Kubernetes ì—…ê·¸ë ˆì´ë“œë¥¼ ì§„í–‰í•˜ì„¸ìš”:
          ansible-playbook playbook.yml
          ==========================================
      run_once: true 